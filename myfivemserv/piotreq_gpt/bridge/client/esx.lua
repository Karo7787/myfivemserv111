local WeaponTable = {
    [584646201]   = "CLASS 2: AP-Pistol",
    [453432689]   = "CLASS 1: Pistol",
    [3219281620]  = "CLASS 1: Pistol MK2",
    [1593441988]  = "CLASS 1: Combat Pistol",
    [GetHashKey("WEAPON_HEAVYPISTOL")] = "CLASS 1: Heavy Pistol",
    [GetHashKey("WEAPON_PISTOL50")] = "CLASS 1: Pistol 50",
    [-1076751822] = "CLASS 1: SNS-Pistol",
    [137902532]   = "CLASS 2: Vintage Pistol",
    [-598887786]  = "CLASS 2: Marksman Pistol",
    [-1045183535] = "CLASS 2: Revolver",
    [911657153]   = "Taser",
    [324215364]   = "CLASS 2: Micro-SMG",
    [-619010992]  = "CLASS 2: Machine-Pistol",
    [736523883]   = "CLASS 2: SMG",
    [2024373456]  = "CLASS 2: SMG MK2",
    [-270015777]  = "CLASS 2: Assault SMG",
    [171789620]   = "CLASS 2: Combat PDW",
    [-1660422300] = "CLASS 4: Combat MG",
    [3686625920]  = "CLASS 4: Combat MG MK2",
    [1627465347]  = "CLASS 4: Gusenberg",
    [-1121678507] = "CLASS 2: Mini SMG",
    [GetHashKey("WEAPON_PISTOL_MK2")] = "CLASS 1: PISTOL MK2",
    [GetHashKey("WEAPON_GLOCK18")] = "CLASS 1: GLOCK 18",
    [-1074790547] = "CLASS 3: Assaultrifle",
    [961495388]   = "CLASS 3: Assaultrifle MK2",
    [-2084633992] = "CLASS 3: Carbinerifle",
    [4208062921]  = "CLASS 3: Carbinerifle MK2",
    [-1357824103] = "CLASS 3: Advancedrifle",
    [-1063057011] = "CLASS 3: Specialcarbine",
    [2132975508]  = "CLASS 3: Bulluprifle",
    [1649403952]  = "CLASS 3: Compactrifle",
    [100416529]   = "CLASS 4: Sniperrifle",
    [205991906]   = "CLASS 4: Heavy Sniper",
    [177293209]   = "CLASS 4: Heavy Sniper MK2",
    [-952879014]  = "CLASS 4: Marksmanrifle",
    [487013001]   = "CLASS 2: Pumpshotgun",
    [2017895192]  = "CLASS 2: Sawnoff Shotgun",
    [-1654528753] = "CLASS 3: Bullupshotgun",
    [-494615257]  = "CLASS 3: Assaultshotgun",
    [-1466123874] = "CLASS 3: Musket",
    [984333226]   = "CLASS 3: Heavyshotgun",
    [-275439685]  = "CLASS 2: Doublebarrel Shotgun",
    [317205821]   = "CLASS 2: Autoshotgun",
    [-1568386805] = "CLASS 5: GRENADE LAUNCHER",
    [-1312131151] = "CLASS 5: RPG",
    [125959754]   = "CLASS 5: Compactlauncher"
}
Config.Colours = {
    ['0'] = "Metaliczny Czarny",
    ['1'] = "Metaliczny Grafitowy Czarny",
    ['2'] = "Metaliczny Czarny Stalowy",
    ['3'] = "Metaliczny Ciemny Srebrny",
    ['4'] = "Metaliczny Srebrny",
    ['5'] = "Metaliczny Niebieski Srebrny",
    ['6'] = "Metaliczny Stalowy Szary",
    ['7'] = "Metaliczny Cienisty Srebrny",
    ['8'] = "Metaliczny Kamienny Srebrny",
    ['9'] = "Metaliczny Nocny Srebrny",
    ['10'] = "Metaliczny Pistoletowy Metal",
    ['11'] = "Metaliczny Antracytowy Szary",
    ['12'] = "Matowy Czarny",
    ['13'] = "Matowy Szary",
    ['14'] = "Matowy Jasny Szary",
    ['15'] = "Użytkowy Czarny",
    ['16'] = "Użytkowy Czarny Poli",
    ['17'] = "Użytkowy Ciemny Srebrny",
    ['18'] = "Użytkowy Srebrny",
    ['19'] = "Użytkowy Pistoletowy Metal",
    ['20'] = "Użytkowy Cienisty Srebrny",
    ['21'] = "Zużyty Czarny",
    ['22'] = "Zużyty Grafitowy",
    ['23'] = "Zużyty Srebrny Szary",
    ['24'] = "Zużyty Srebrny",
    ['25'] = "Zużyty Niebieski Srebrny",
    ['26'] = "Zużyty Cienisty Srebrny",
    ['27'] = "Metaliczny Czerwony",
    ['28'] = "Metaliczny Turyn Czerwony",
    ['29'] = "Metaliczny Formuła Czerwony",
    ['30'] = "Metaliczny Płomienny Czerwony",
    ['31'] = "Metaliczny Elegancki Czerwony",
    ['32'] = "Metaliczny Granatowy Czerwony",
    ['33'] = "Metaliczny Pustynny Czerwony",
    ['34'] = "Metaliczny Cabernet Czerwony",
    ['35'] = "Metaliczny Cukierkowy Czerwony",
    ['36'] = "Metaliczny Wschodzący Pomarańczowy",
    ['37'] = "Metaliczny Klasyczny Złoty",
    ['38'] = "Metaliczny Pomarańczowy",
    ['39'] = "Matowy Czerwony",
    ['40'] = "Matowy Ciemny Czerwony",
    ['41'] = "Matowy Pomarańczowy",
    ['42'] = "Matowy Żółty",
    ['43'] = "Użytkowy Czerwony",
    ['44'] = "Użytkowy Jasny Czerwony",
    ['45'] = "Użytkowy Granatowy Czerwony",
    ['46'] = "Zużyty Czerwony",
    ['47'] = "Zużyty Złocisty Czerwony",
    ['48'] = "Zużyty Ciemny Czerwony",
    ['49'] = "Metaliczny Ciemny Zielony",
    ['50'] = "Metaliczny Wyścigowy Zielony",
    ['51'] = "Metaliczny Morski Zielony",
    ['52'] = "Metaliczny Oliwkowy Zielony",
    ['53'] = "Metaliczny Zielony",
    ['54'] = "Metaliczny Benzynowy Niebiesko-Zielony",
    ['55'] = "Matowy Limonkowy Zielony",
    ['56'] = "Użytkowy Ciemny Zielony",
    ['57'] = "Użytkowy Zielony",
    ['58'] = "Zużyty Ciemny Zielony",
    ['59'] = "Zużyty Zielony",
    ['60'] = "Zużyty Praniowy Niebieski",
    ['61'] = "Metaliczny Nocny Niebieski",
    ['62'] = "Metaliczny Ciemny Niebieski",
    ['63'] = "Metaliczny Saksoński Niebieski",
    ['64'] = "Metaliczny Niebieski",
    ['65'] = "Metaliczny Marynarski Niebieski",
    ['66'] = "Metaliczny Portowy Niebieski",
    ['67'] = "Metaliczny Diamentowy Niebieski",
    ['68'] = "Metaliczny Surfowy Niebieski",
    ['69'] = "Metaliczny Nautyczny Niebieski",
    ['70'] = "Metaliczny Jasny Niebieski",
    ['71'] = "Metaliczny Fioletowo-Niebieski",
    ['72'] = "Metaliczny Żaglowy Niebieski",
    ['73'] = "Metaliczny Ultra Niebieski",
    ['74'] = "Metaliczny Jasny Niebieski",
    ['75'] = "Użytkowy Ciemny Niebieski",
    ['76'] = "Użytkowy Nocny Niebieski",
    ['77'] = "Użytkowy Niebieski",
    ['78'] = "Użytkowy Piankowy Niebieski",
    ['79'] = "Użytkowy Błyskawicowy Niebieski",
    ['80'] = "Użytkowy Maui Niebieski Poli",
    ['81'] = "Użytkowy Jasny Niebieski",
    ['82'] = "Matowy Ciemny Niebieski",
    ['83'] = "Matowy Niebieski",
    ['84'] = "Matowy Nocny Niebieski",
    ['85'] = "Zużyty Ciemny Niebieski",
    ['86'] = "Zużyty Niebieski",
    ['87'] = "Zużyty Jasny Niebieski",
    ['88'] = "Metaliczny Taksówkowy Żółty",
    ['89'] = "Metaliczny Wyścigowy Żółty",
    ['90'] = "Metaliczny Brązowy",
    ['91'] = "Metaliczny Żółty Ptak",
    ['92'] = "Metaliczny Limonkowy",
    ['93'] = "Metaliczne Szampan",
    ['94'] = "Metaliczny Pueblo Beżowy",
    ['95'] = "Metaliczny Ciemny Kość Słoniowa",
    ['96'] = "Metaliczny Czekoladowy Brązowy",
    ['97'] = "Metaliczny Złocisty Brązowy",
    ['98'] = "Metaliczny Jasnobrązowy",
    ['99'] = "Metaliczny Słomkowy Beżowy",
    ['100'] = "Metaliczny Mechowy Brązowy",
    ['101'] = "Metaliczny Biston Brązowy",
    ['102'] = "Metaliczne Bukowe Drewno",
    ['103'] = "Metaliczne Ciemne Bukowe Drewno",
    ['104'] = "Metaliczny Czekoladowy Pomarańczowy",
    ['105'] = "Metaliczny Piasek Plażowy",
    ['106'] = "Metaliczny Wyblakły Słońcem Piasek",
    ['107'] = "Metaliczny Kremowy",
    ['108'] = "Użytkowy Brązowy",
    ['109'] = "Użytkowy Średni Brązowy",
    ['110'] = "Użytkowy Jasnobrązowy",
    ['111'] = "Metaliczny Biały",
    ['112'] = "Metaliczny Mroźny Biały",
    ['113'] = "Zużyty Miodowy Beżowy",
    ['114'] = "Zużyty Brązowy",
    ['115'] = "Zużyty Ciemny Brązowy",
    ['116'] = "Zużyty Słomkowy Beżowy",
    ['117'] = "Szczotkowana Stal",
    ['118'] = "Szczotkowana Czarna Stal",
    ['119'] = "Szczotkowane Aluminium",
    ['120'] = "Chrom",
    ['121'] = "Zużyty Złamany Biały",
    ['122'] = "Użytkowy Złamany Biały",
    ['123'] = "Zużyty Pomarańczowy",
    ['124'] = "Zużyty Jasny Pomarańczowy",
    ['125'] = "Metaliczny Zielony Securicor",
    ['126'] = "Zużyty Taksówkowy Żółty",
    ['127'] = "Niebieski Radiowozu",
    ['128'] = "Matowy Zielony",
    ['129'] = "Matowy Brązowy",
    ['130'] = "Zużyty Pomarańczowy",
    ['131'] = "Matowy Biały",
    ['132'] = "Zużyty Biały",
    ['133'] = "Zużyty Oliwkowy Wojskowy Zielony",
    ['134'] = "Czysta Biel",
    ['135'] = "Gorący Różowy",
    ['136'] = "Łososiowy Różowy",
    ['137'] = "Metaliczny Cynobrowy Różowy",
    ['138'] = "Pomarańczowy",
    ['139'] = "Zielony",
    ['140'] = "Niebieski",
    ['141'] = "Metaliczny Czarny Niebieski",
    ['142'] = "Metaliczny Czarny Fioletowy",
    ['143'] = "Metaliczny Czarny Czerwony",
    ['144'] = "Myśliwski Zielony",
    ['145'] = "Metaliczny Fioletowy",
    ['146'] = "Metaliczny Ciemny Niebieski",
    ['147'] = "Czarny",
    ['148'] = "Matowy Fioletowy",
    ['149'] = "Matowy Ciemny Fioletowy",
    ['150'] = "Metaliczny Lawa Czerwony",
    ['151'] = "Matowy Leśny Zielony",
    ['152'] = "Matowy Oliwkowy Drab",
    ['153'] = "Matowy Pustynny Brązowy",
    ['154'] = "Matowy Pustynny Beżowy",
    ['155'] = "Matowy Liściasty Zielony",
    ['156'] = "Domyślny Kolor Stopu",
    ['157'] = "Epsilonowy Niebieski",
    ['158'] = "Czyste Złoto",
    ['159'] = "Szczotkowane Złoto",
    ['160'] = "MP100"
}

function getCardinalDirectionFromHeading()
    local zwrot = GetEntityHeading(PlayerPedId())

    if zwrot >= 315 or zwrot < 45 then
        return "Kierunek północny"
    elseif zwrot >= 45 and zwrot < 135 then
        return "Kierunek zachodni"
    elseif zwrot >= 135 and zwrot < 225 then
        return "Kierunek południowy"
    elseif zwrot >= 225 and zwrot < 315 then
        return "Kierunek wschodni"
    end
end


local playAnim = false
local phoneProp = 0
local phoneModel = "lb_phone_prop"

-- Loads the animdict so we can execute it on the ped
local function loadAnimDict(dict)
    RequestAnimDict(dict)

    while not HasAnimDictLoaded(dict) do
        Wait(0)
    end
end

local function DeletePhone()
	if phoneProp ~= 0 then
		DeleteObject(phoneProp)
		phoneProp = 0
	end
end

local function NewPropWhoDis()
	DeletePhone()
	RequestModel(phoneModel)
	while not HasModelLoaded(phoneModel) do
		Wait(1)
	end
	phoneProp = CreateObject(phoneModel, 1.0, 1.0, 1.0, 1, 1, 0)

	local bone = GetPedBoneIndex(PlayerPedId(), 28422)
	if phoneModel == "lb_phone_prop" then
		AttachEntityToEntity(phoneProp, PlayerPedId(), bone, 0.0, 0.0, 0.0, 15.0, 0.0, 180.0, 1, 1, 0, 0, 2, 1)
	else
		AttachEntityToEntity(phoneProp, PlayerPedId(), bone, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1, 1, 0, 0, 2, 1)
	end
end

-- Does the actual animation of the animation when calling 911
local function PhoneCallAnim()
    loadAnimDict("cellphone@")
    local ped = PlayerPedId()
    CreateThread(function()
        NewPropWhoDis()
        playAnim = true
        while playAnim do
            if not IsEntityPlayingAnim(ped, "cellphone@", 'cellphone_text_to_call', 3) then
                TaskPlayAnim(ped, "cellphone@", 'cellphone_text_to_call', 3.0, 3.0, -1, 50, 0, false, false, false)
            end
            Wait(100)
        end
    end)
end

function vehicleData(vehicle)
	local vData = {}
	local vehicleClass = GetVehicleClass(vehicle)
	local vClass = {[0] = locale('compact'), [1] = locale('sedan'), [2] = locale('suv'), [3] = locale('coupe'), [4] = locale('muscle'), [5] = locale('sports_classic'), [6] = locale('sports'), [7] = locale('super'), [8] = locale('motorcycle'), [9] = locale('offroad'), [10] = locale('industrial'), [11] = locale('utility'), [12] = locale('van'), [17] = locale('service'), [19] = locale('military'), [20] = locale('truck')}
	local vehClass = vClass[vehicleClass]
	local vehicleName = GetLabelText(GetDisplayNameFromVehicleModel(GetEntityModel(vehicle)))
	local vehicleColour1, vehicleColour2 = GetVehicleColours(vehicle)
	if vehicleColour1 then
		if Config.Colours[tostring(vehicleColour2)] and Config.Colours[tostring(vehicleColour1)] then
			vehicleColour = Config.Colours[tostring(vehicleColour2)] .. " na " .. Config.Colours[tostring(vehicleColour1)]
		elseif Config.Colours[tostring(vehicleColour1)] then
			vehicleColour = Config.Colours[tostring(vehicleColour1)]
		elseif Config.Colours[tostring(vehicleColour2)] then
			vehicleColour = Config.Colours[tostring(vehicleColour2)]
		else
			vehicleColour = "Nieznany"
		end
	end
	local plate = GetVehicleNumberPlateText(vehicle)
	vData.class, vData.name, vData.colour, vData.plate, vData.id = vehClass, vehicleName, vehicleColour, plate, NetworkGetNetworkIdFromEntity(vehicle)
	return vData
end


if Config.Framework:upper() ~= 'ESX' then return end

GPT.Editable = {}

GPT.Editable.Notify = function(text, type)
    type = type or 'inform'
    lib.notify({
        title = 'GPT',
        description = text,
        type = type
    })
end

GPT.Editable.GetPlayerIdentifier = function()
    return LocalPlayer.state.identifier
end

GPT.Editable.SpawnVehicle = function(model, coords, heading, cb)
    ESX.Game.SpawnVehicle(model, coords, heading, cb)
end

GPT.Editable.SetVehProperties = function(vehicle, properties)
    ESX.Game.SetVehicleProperties(vehicle, properties)
end

GPT.Editable.IsPointClear = function(coords, dist)
    return ESX.Game.IsSpawnPointClear(vector3(coords.x, coords.y, coords.z), dist or 4.0)
end

GPT.Editable.FormatPlate = function(plateFormat)
    return plateFormat:format(math.random(111111, 999999)) -- example 'PD123456'
end

GPT.Editable.GetPlayerJob = function()
    local playerJob = ESX.PlayerData.job
    return {
        name = playerJob.name,
        grade = tonumber(playerJob.grade),
        label = playerJob.label,
    }
end

lib.addKeybind({
    name = 'Dispatch',
    description = locale('dispatch'),
    defaultKey = 'DELETE',
    onPressed = function(self)
        OpenDispatch()
    end,
})
Config.Timer = {
    ["Shooting"] = 0,
    ["Melee"] = 0,
    ["Thief"] = 0
}

Config.WeaponBlacklist = {
    'WEAPON_GRENADE',
    'WEAPON_GADGETPISTOL',
    'WEAPON_BZGAS',
    'WEAPON_MOLOTOV',
    'WEAPON_STICKYBOMB',
    'WEAPON_PROXMINE',
    'WEAPON_SNOWBALL',
    'WEAPON_PIPEBOMB',
    'WEAPON_BALL',
    'WEAPON_SMOKEGRENADE',
    'WEAPON_FLARE',
    'WEAPON_PETROLCAN',
    'WEAPON_FIREEXTINGUISHER',
    'WEAPON_HAZARDCAN',
    'WEAPON_RAYCARBINE',
    'weapon_musket',
    'WEAPON_RADAR',
    'WEAPON_THROWLINE',
    'WEAPON_STUNGUN',
    "WEAPON_PLASMAP_BLUE",
    "WEAPON_PLASMAP_RED"
}
local vehicleWhitelist = {[0]=true,[1]=true,[2]=true,[3]=true,[4]=true,[5]=true,[6]=true,[7]=true,[8]=true,[9]=true,[10]=true,[11]=true,[12]=true,[17]=true,[19]=true,[20]=true}

local function isPlayerAWitness(witnesses)
    for k, v in pairs(witnesses) do
        if v == PlayerPedId() then
            return true
        end
    end
    return false
end

function BlacklistedWeapon(playerPed)
	for i = 1, #Config.WeaponBlacklist do
		local weaponHash = GetHashKey(Config.WeaponBlacklist[i])
		if GetSelectedPedWeapon(playerPed) == weaponHash then
			return true -- Is a blacklisted weapon
		end
	end
	return false -- Is not a blacklisted weapon
end

-- ---@param witnesses table | Array of peds that witnessed the event, where witnesses[1] is the victim
-- ---@param attacker number | The ped that attacked the victim
-- AddEventHandler('CEventMeleeAction', function(witnesses, attacker)
-- 	-- The ped that melee attacked must be the player.
--     if PlayerPedId() ~= attacker then return end
--     -- If the player is a whitelisted job, then we don't want to trigger the event.
--     -- However, if the player is not whitelisted or Debug mode is true, then we want to trigger the event.
--     -- if Config.Jobs[GPT.Editable.GetPlayerJob().name] then return end
--     if Config.Timer['Melee'] == 0 then
--         TriggerServerEvent('piotreq_gpt:alert:fight')
--         Config.Timer['Melee'] = 30
--     end
-- end)
AddEventHandler('CEventPedJackingMyVehicle', function(_, ped)
    if Config.Timer['Thief'] == 0 then
        if Config.Jobs[GPT.Editable.GetPlayerJob().name] then return end
        Config.Timer['Thief'] = 60
        Citizen.Wait(10000)
        if PlayerPedId() ~= ped then return end
        local vehicle = GetVehiclePedIsUsing(ped, true)
        if vehicle then
            local vehdata = vehicleData(vehicle)
            local doorCount = 0
            if GetEntityBoneIndexByName(vehicle, 'door_pside_f') ~= -1 then doorCount = doorCount + 1 end
            if GetEntityBoneIndexByName(vehicle, 'door_pside_r') ~= -1 then doorCount = doorCount + 1 end
            if GetEntityBoneIndexByName(vehicle, 'door_dside_f') ~= -1 then doorCount = doorCount + 1 end
            if GetEntityBoneIndexByName(vehicle, 'door_dside_r') ~= -1 then doorCount = doorCount + 1 end
            if doorCount == 2 then 
                doorCount = "Dwudrzwiowy" 
            elseif doorCount == 3 then 
                doorCount = "Trzydrzwiowy" 
            elseif doorCount == 4 then 
                doorCount = "Czterodrzwiowy" 
            else 
                doorCount = "Nieznana" 
            end    
            TriggerServerEvent('piotreq_gpt:alert:vehicle_jacking', doorCount, vehdata)
        end
    end
end)
---@param witnesses table  array of peds that witnessed the shots
---@param ped number  the ped that shot the gun
AddEventHandler("CEventGunShot", function(witnesses, ped)
    if PlayerPedId() ~= ped then return end
    if witnesses and not isPlayerAWitness(witnesses) then return end
    local vehicle = GetVehiclePedIsUsing(ped, true)
    if vehicle ~= 0 then
        if vehicleWhitelist[GetVehicleClass(vehicle)] then
            local driver = GetPedInVehicleSeat(vehicle, -1)
            if Config.Timer['Shooting'] == 0 and not BlacklistedWeapon(ped) and not IsPedCurrentWeaponSilenced(ped) and IsPedArmed(ped, 4) then
                if IsPedShooting(ped) then
                    local vehdata = vehicleData(vehicle)
                    local heading = getCardinalDirectionFromHeading()
                    local doorCount = 0
                    local CurrentWeapon = GetSelectedPedWeapon(ped)
                    local weapon = WeaponTable[CurrentWeapon] or "Nieznane"
                    if GetEntityBoneIndexByName(vehicle, 'door_pside_f') ~= -1 then doorCount = doorCount + 1 end
                    if GetEntityBoneIndexByName(vehicle, 'door_pside_r') ~= -1 then doorCount = doorCount + 1 end
                    if GetEntityBoneIndexByName(vehicle, 'door_dside_f') ~= -1 then doorCount = doorCount + 1 end
                    if GetEntityBoneIndexByName(vehicle, 'door_dside_r') ~= -1 then doorCount = doorCount + 1 end
                    if doorCount == 2 then 
                        doorCount = "Dwudrzwiowy" 
                    elseif doorCount == 3 then 
                        doorCount = "Trzydrzwiowy" 
                    elseif doorCount == 4 then 
                        doorCount = "Czterodrzwiowy" 
                    else 
                        doorCount = "Nieznana" 
                    end    
                    TriggerServerEvent('piotreq_gpt:alert:vehicle_shooting', Config.Jobs[GPT.Editable.GetPlayerJob().name] and "police" or "normal", weapon, heading, doorCount, vehdata)
                    Config.Timer['Shooting'] = 10
                end
            end
        end
    else
        if Config.Timer['Shooting'] == 0  and not IsPedCurrentWeaponSilenced(ped) and IsPedArmed(ped, 4) then
            if IsPedShooting(ped) and not BlacklistedWeapon(ped) then
                local CurrentWeapon = GetSelectedPedWeapon(ped)
                local weapon = WeaponTable[CurrentWeapon] or "Nieznane"
                TriggerServerEvent('piotreq_gpt:alert:shooting', Config.Jobs[GPT.Editable.GetPlayerJob().name] and "police" or "normal", weapon)
                Config.Timer['Shooting'] = 10
            end
        end
    end
end)


local last911Used = 0

-- Regular 911 call that goes straight to the Police
RegisterCommand('911', function(source, args, rawCommand)
    local timeNow = GetCloudTimeAsInt()

    if timeNow - last911Used <= 60 then
        return ESX.ShowNotification("Poczekaj przed ponowym użyciem", "error")
    end

    last911Used = timeNow
    local msg = rawCommand:sub(5)
    if string.len(msg) > 0 then
        if not LocalPlayer.state.isCuffed then
            if exports.ox_inventory:GetItemCount("phone") >= 1 then
                PhoneCallAnim()
                Wait(math.random(3,8) * 1000)
                playAnim = false
                TriggerServerEvent('piotreq_gpt:alert:911', false, msg)
                Wait(1000)
                DeletePhone()
                StopEntityAnim(PlayerPedId(), 'cellphone_text_to_call', "cellphone@", 3)
            else
                lib.notify({
                    description = "Nie możesz wykonać połączenia bez telefonu!",
                    type = "error"
                })
            end
        else
            lib.notify({
                description = "Nie możesz wykonać połączenia będąc zakutym!",
                type = "error"
            })
        end
    else
        lib.notify({
            description = "Podaj jako argument wiadomość!",
            type = "error"
        })
    end
end)

RegisterCommand('911a', function(source, args, rawCommand)
    local msg = rawCommand:sub(5)
    if string.len(msg) > 0 then
        if not LocalPlayer.state.isCuffed then
            if exports.ox_inventory:GetItemCount("phone") >= 1 then
                PhoneCallAnim()
                Wait(math.random(3,8) * 1000)
                playAnim = false
                TriggerServerEvent('piotreq_gpt:alert:911', true, msg)
                Wait(1000)
                DeletePhone()
                StopEntityAnim(PlayerPedId(), 'cellphone_text_to_call', "cellphone@", 3)
            else
                lib.notify({
                    description = "Nie możesz wykonać połączenia bez telefonu!",
                    type = "error"
                })
            end
        else
            lib.notify({
                description = "Nie możesz wykonać połączenia będąc zakutym!",
                type = "error"
            })
        end
    else
        lib.notify({
            description = "Podaj jako argument wiadomość!",
            type = "error"
        })
    end
end)

-- local hasWeapon = false
-- lib.onCache('weapon', function(value)
--     if value then
--         hasWeapon = true
--         Citizen.CreateThread(function()
--             while hasWeapon do
--                 local sleep = 500
--                 if IsPedArmed(cache.ped, 1 | 2 | 4) then
--                     sleep = 250
--                     if IsPlayerFreeAiming(cache.playerId) then
--                         sleep = 100
--                         if IsPedShooting(cache.ped) and not IsPedCurrentWeaponSilenced(cache.ped) then
--                             TriggerServerEvent('piotreq_gpt:ShotAlert')
--                             sleep = 2500
--                         end
--                     end
--                 end
--                 Wait(sleep)
--             end
--         end)
--     else
--         hasWeapon = false
--     end
-- end)

CreateThread(function()
	local sleep = 1000
	while true do
        for k, v in pairs(Config.Timer) do
            if v > 0 then Config.Timer[k] = v - 1 end
        end
		Wait(sleep)
	end
end)


